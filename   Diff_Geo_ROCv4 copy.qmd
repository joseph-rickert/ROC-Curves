---
title: "Using Differential Geometry to Analyze ROC Curves"
author: Joseph Rickert
date: November 16, 2025
format: html
---


```{r}
#| message: FALSE
#| warning: FALSE
#| code-fold: TRUE
#| code-summary: "Show the packages required"
library(tidyverse)
library(ggplot2)
library(scales)
library(pROC)
```


### Simulated Data

```{r}
library(dplyr)
library(pROC)

# --- Parameters ---
set.seed(123)
n_signal <- 75
n_noise  <- 300

# Distribution functions (easy to swap out)
signal_dist <- function(n) rnorm(n, mean = 1.0, sd = 1.0)   # signal scores
noise_dist  <- function(n) rnorm(n, mean = 0.0, sd = 1.0)   # noise scores

# --- Generate test data ---
test_data <- data.frame(
  Class = c(rep(1, n_signal), rep(2, n_noise)),   # 1 = signal, 2 = noise
  probability = c(signal_dist(n_signal), noise_dist(n_noise))
)

head(test_data)
# # --- Build ROC object ---
# roc_obj <- roc(response = test_data$Class,
#                predictor = test_data$probability,
#                levels = c(2,1), # noise=2, signal=1
#                direction = "<")
# 
# # --- Check AUC ---
# auc_val <- auc(roc_obj)
# print(paste("AUC =", round(auc_val, 3)))

```






```{r}
# library(dplyr)
# library(ggplot2)
# library(pROC)

# --- Step 1: Example test data ---
# Replace with your actual data frame
set.seed(123)
# n <- 200
# test_data <- data.frame(
#   Class = sample(c(1,2), n, replace = TRUE, prob = c(0.4, 0.6)),
#   probability = runif(n)
# )
# 
# # --- Step 2: Build ROC data ---
# roc_obj <- roc(response = test_data$Class,
#                predictor = test_data$probability,
#                levels = c(2,1), # noise=2, signal=1
#                direction = "<")


# --- Build ROC object ---
roc_obj <- roc(response = test_data$Class,
               predictor = test_data$probability,
               levels = c(2,1), # noise=2, signal=1
               direction = "<")

# --- Check AUC ---
auc_val <- auc(roc_obj)
print(paste("AUC =", round(auc_val, 3)))

roc_df <- data.frame(
  threshold   = roc_obj$thresholds,
  TPR         = roc_obj$sensitivities,
  FPR         = 1 - roc_obj$specificities,
  Specificity = roc_obj$specificities
)

# --- Step 3: Compute cumulative arc length ---
dx <- diff(roc_df$FPR)
dy <- diff(roc_df$TPR)
ds <- sqrt(dx^2 + dy^2)
roc_df$ArcLength <- c(0, cumsum(ds))

# --- Step 4: Compute polyline curvature (discrete approximation) ---
# Curvature κ_i ≈ Δθ / Δs, where θ = atan2(dy, dx)
theta <- atan2(dy, dx)
dtheta <- c(NA, diff(theta))
curvature <- dtheta / ds
roc_df$Curvature <- c(NA, curvature)

# --- Step 5: Compute AUC using pROC ---
auc_val <- auc(roc_obj)

# --- Step 6: Plot ROC curve with legend showing AUC and arc length ---
ggplot(roc_df, aes(x = FPR, y = TPR)) +
  geom_line(color = "#2C7FB8", size = 1.3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50") +
  labs(title = "ROC Curve with Arc Length and AUC",
       x = "False Positive Rate (FPR)",
       y = "True Positive Rate (TPR)") +
  annotate("text", x = 0.6, y = 0.2,
           label = paste0("AUC = ", round(auc_val, 3),
                          "\nCum Arc Length = ", round(max(roc_df$ArcLength), 3)),
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

```


```{r}
library(dplyr)
library(ggplot2)
library(pROC)
library(splines)

# --- Step 1: Assume roc_df has FPR and TPR ---
roc_df <- roc_df %>% arrange(FPR)

# --- Step 2: Smooth ROC curve using spline interpolation ---
spline_fit <- smooth.spline(x = roc_df$FPR, y = roc_df$TPR, spar = 0.7)
FPR_smooth <- seq(0, 1, length.out = 200)
TPR_smooth <- predict(spline_fit, x = FPR_smooth)$y

# --- Step 3: Compute derivatives for curvature ---
dy_dx  <- predict(spline_fit, x = FPR_smooth, deriv = 1)$y
d2y_dx2 <- predict(spline_fit, x = FPR_smooth, deriv = 2)$y

# Standard curvature formula: κ(x) = y'' / (1 + (y')^2)^(3/2)
curvature <- d2y_dx2 / ( (1 + dy_dx^2)^(3/2) )

# --- Step 4: Compute smooth arc length ---
dx <- diff(FPR_smooth)
dy <- diff(TPR_smooth)
ds <- sqrt(dx^2 + dy^2)
arc_length_smooth <- c(0, cumsum(ds))

# --- Step 5: Compute smooth AUC using trapezoidal rule ---
AUC_smooth <- sum( (TPR_smooth[-1] + TPR_smooth[-length(TPR_smooth)]) / 2 * diff(FPR_smooth) )

# --- Step 6: Add new variables to roc_df (interpolated to same grid) ---
roc_smooth_df <- data.frame(
  FPR = FPR_smooth,
  TPR = TPR_smooth,
  Curvature = curvature,
  ArcLength = arc_length_smooth
)

# --- Step 7: Overlay plot ---
ggplot() +
  geom_line(data = roc_df, aes(x = FPR, y = TPR),
            color = "#d95f02", size = 1.2, alpha = 0.7) +
  geom_line(data = roc_smooth_df, aes(x = FPR, y = TPR),
            color = "#2C7FB8", size = 1.3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50") +
  labs(title = "Raw vs Smoothed ROC Curve",
       x = "False Positive Rate (FPR)",
       y = "True Positive Rate (TPR)") +
  annotate("text", x = 0.6, y = 0.2,
           label = paste0("Smooth AUC = ", round(AUC_smooth, 3),
                          "\nSmooth Arc Length = ", round(max(roc_smooth_df$ArcLength), 3)),
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

```

```{r}
library(dplyr)
library(ggplot2)

# --- Assume roc_df has FPR and TPR ---
roc_df <- roc_df %>% arrange(FPR)

# --- Smooth ROC curve using spline interpolation ---
spline_fit <- smooth.spline(x = roc_df$FPR, y = roc_df$TPR, spar = 0.7)
FPR_smooth <- seq(0, 1, length.out = 200)
TPR_smooth <- predict(spline_fit, x = FPR_smooth)$y

roc_smooth_df <- data.frame(FPR = FPR_smooth, TPR = TPR_smooth)

# --- Separate plot: raw points + smoothed curve ---
ggplot() +
  geom_point(data = roc_df, aes(x = FPR, y = TPR),
             color = "#d95f02", size = .5, alpha = 0.7) +
  geom_line(data = roc_smooth_df, aes(x = FPR, y = TPR),
            color = "#2C7FB8", size = 1.3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50") +
  labs(title = "Raw ROC Points with Smoothed ROC Curve",
       x = "False Positive Rate (FPR)",
       y = "True Positive Rate (TPR)") +
  theme_minimal()

```


```{r}
library(dplyr)
library(ggplot2)
library(pROC)

# --- Assume roc_df has columns: threshold, FPR, TPR ---
roc_df <- roc_df %>% arrange(FPR)

# --- Step 1: Smooth ROC curve using spline interpolation ---
spline_fit <- smooth.spline(x = roc_df$FPR, y = roc_df$TPR, spar = 0.7)

# --- Step 2: Evaluate spline at thresholds ---
TPR_smooth <- predict(spline_fit, x = roc_df$FPR)$y

# --- Step 3: Compute derivatives for curvature ---
dy_dx   <- predict(spline_fit, x = roc_df$FPR, deriv = 1)$y
d2y_dx2 <- predict(spline_fit, x = roc_df$FPR, deriv = 2)$y

# --- Step 4: Curvature formula ---
curvature <- d2y_dx2 / ( (1 + dy_dx^2)^(3/2) )

# --- Step 5: Add smoothed variables to roc_df ---
roc_df <- roc_df %>%
  mutate(TPR_smooth = TPR_smooth,
         Curvature_smooth = curvature)

# --- Step 6: Plot smoothed curvature vs threshold ---
ggplot(roc_df, aes(x = threshold, y = Curvature_smooth)) +
  geom_line(color = "#2C7FB8", size = 1.3) +
  labs(title = "Smoothed ROC Curvature vs Threshold",
       x = "Threshold",
       y = "Smoothed Curvature") +
  theme_minimal()

```


```{r}
library(dplyr)
library(ggplot2)

# --- Assume roc_df has FPR and TPR ---
roc_df <- roc_df %>% arrange(FPR)

# --- Step 1: Smooth ROC curve using spline interpolation ---
spline_fit <- smooth.spline(x = roc_df$FPR, y = roc_df$TPR, spar = 0.7)

# Dense grid for evaluation
FPR_smooth <- seq(0, 1, length.out = 200)
TPR_smooth <- predict(spline_fit, x = FPR_smooth)$y

# --- Step 2: Derivatives for curvature ---
dy_dx   <- predict(spline_fit, x = FPR_smooth, deriv = 1)$y
d2y_dx2 <- predict(spline_fit, x = FPR_smooth, deriv = 2)$y

# Curvature formula κ(x) = y'' / (1+(y')^2)^(3/2)
curvature <- d2y_dx2 / ( (1 + dy_dx^2)^(3/2) )

# --- Step 3: Compute cumulative arc length ---
dx <- diff(FPR_smooth)
dy <- diff(TPR_smooth)
ds <- sqrt(dx^2 + dy^2)
arc_length <- c(0, cumsum(ds))

# --- Step 4: Build smooth ROC data frame ---
roc_smooth_df <- data.frame(
  FPR = FPR_smooth,
  TPR = TPR_smooth,
  ArcLength = arc_length,
  Curvature = curvature
)

# --- Step 5: Plot curvature vs cumulative arc length ---
ggplot(roc_smooth_df, aes(x = ArcLength, y = Curvature)) +
  geom_line(color = "#2C7FB8", size = 1.3) +
  labs(title = "Smoothed ROC Curvature vs Cumulative Arc Length",
       x = "Cumulative Arc Length",
       y = "Smoothed Curvature") +
  theme_minimal()

```


